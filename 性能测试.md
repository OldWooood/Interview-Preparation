# 全链路性能测试指南（含示意图）

本文档整理了全链路性能测试的概念、方法、工具方案和实践经验，包括基于 **K6**、工具无关方案以及 **JMeter** 的实现方式，帮助构建可落地的全链路压测体系。

---

## 1️⃣ 全链路性能测试概念

全链路性能测试（End-to-End Performance Testing）是对**整个业务链路**的性能进行测试，包括：

- 前端请求
- API 网关
- 后端服务
- 数据库
- 缓存
- 消息队列
- 第三方服务

目标是通过模拟真实用户行为，发现业务链路上各环节的性能瓶颈，保证系统在高负载下稳定运行。

---

## 2️⃣ 全链路性能测试核心步骤

1. **明确业务链路**
   - 绘制请求流转图
   - 确定核心业务场景
   - 明确压测目标（并发用户数、持续时间、峰值流量）

2. **准备压测环境**
   - 选择接近生产的环境
   - 对第三方接口进行 mock 或使用影子环境

3. **脚本编写**
   - 将业务链路拆成 API 调用序列
   - 参数化用户数据、商品信息等
   - 模拟真实用户思考时间

4. **执行压测**
   - 逐步 ramp-up 增加压力
   - 持续运行，收集稳定阶段数据

5. **实时监控**
   - 系统指标：CPU、内存、带宽、磁盘 IO
   - 应用指标：请求量、响应时间、错误率
   - 链路追踪：请求在各微服务耗时
   - 数据库、缓存、消息队列指标

6. **分析结果**
   - 找出性能瓶颈
   - 对比基准指标
   - 优化后回归测试

---

## 3️⃣ K6 实现全链路压测示例

### 3.1 脚本示例

```javascript
import http from 'k6/http';
import { sleep, check } from 'k6';

export let options = {
  stages: [
    { duration: '30s', target: 50 },
    { duration: '1m', target: 50 },
    { duration: '30s', target: 0 },
  ],
};

export default function () {
  let loginRes = http.post('https://api.example.com/login', { user: 'u1', pwd: 'p1' });
  check(loginRes, { '登录成功': (r) => r.status === 200 });
  let token = loginRes.json('token');

  let searchRes = http.get(`https://api.example.com/search?q=phone`, {
    headers: { Authorization: `Bearer ${token}` },
  });
  check(searchRes, { '搜索成功': (r) => r.status === 200 });

  let orderRes = http.post(
    `https://api.example.com/order`,
    JSON.stringify({ productId: '123', quantity: 1 }),
    { headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` } }
  );
  check(orderRes, { '下单成功': (r) => r.status === 200 });

  sleep(1);
}
````

### 3.2 K6 + 全链路监控示意图

```
       [K6 压测脚本]
              │
              ▼
         [API 网关]
              │
              ▼
   ┌─────────┴─────────┐
   │                   │
[微服务A]           [微服务B]
   │                   │
   ▼                   ▼
[数据库]             [缓存 / MQ]
   │
   ▼
[链路追踪 & 指标采集]
   │
   ▼
[Prometheus / Grafana 可视化]
```

---

## 4️⃣ 工具无关的全链路压测设计

### 4.1 核心思想

* 压测工具只负责造流量
* 监控体系负责采集全链路指标
* 脚本和场景配置采用统一格式（JSON/YAML）

### 4.2 压测场景示例 YAML

```yaml
scenarios:
  - name: order-flow
    steps:
      - login:
          method: POST
          url: /login
          payload: { user: "u1", pwd: "p1" }
      - search:
          method: GET
          url: /search?q=phone
      - order:
          method: POST
          url: /order
          payload: { productId: "123", quantity: 1 }
    vus: 100
    duration: 5m
```

### 4.3 工具无关全链路架构示意

```
 [压测工具集群]   ----->  [API 网关] ---> [微服务] ---> [数据库 / 缓存 / MQ]
    |                       |             |
    |                       v             v
    |                [监控采集器]   [链路追踪 Agent]
    |                       |             |
    v                       v             v
 [压测指标收集]  <--->  [Prometheus]  <--->  [Grafana 仪表盘]
```

---

## 5️⃣ JMeter 全链路压测实践

### 5.1 脚本设计

* Thread Group / Ultimate Thread Group
* 核心步骤：

  * 登录接口
  * 搜索商品
  * 下单
  * 支付
* 参数化：CSV Data Set Config
* 模拟用户停顿：Timers

### 5.2 分布式发压

* Master-Slave 模式
* 容器化部署（Kubernetes + Docker）

### 5.3 监控方案

* JMeter Backend Listener → InfluxDB → Grafana
* 系统指标：Prometheus Node Exporter
* 链路追踪：SkyWalking / Jaeger
* 数据库监控：慢查询、TPS、锁等待

### 5.4 JMeter 全链路架构示意

```
        [JMeter Master]
             │
   ------------------------
   |         |            |
[Slave1]  [Slave2]    [Slave3]
   │         │            │
   ▼         ▼            ▼
[API网关] -> [微服务] -> [数据库 / 缓存 / MQ]
   │
   ▼
[链路追踪 Agent] ---> [SkyWalking / Jaeger 可视化]
   │
   ▼
[Prometheus + InfluxDB] ---> [Grafana 全链路仪表盘]
```

---

## 6️⃣ 压测工具作用与监控结合

### 6.1 压测工具本质

* 核心功能：**造流量**
* 输出：TPS、QPS、响应时间、错误率
* 无法直接定位后端瓶颈

### 6.2 监控体系的重要性

* 系统指标：CPU、内存、网络、IO
* 应用指标：线程池、请求量、错误率
* 数据库指标：TPS/QPS、慢查询
* 链路追踪：请求在各服务耗时

### 6.3 全链路工作流示意

```
        [压测工具]
           │  (发流量)
           ▼
[API 网关] -> [业务服务] -> [数据库 / 缓存 / MQ]
           │
           ▼
   [监控采集器] ---> [Prometheus] ---> [Grafana]
           │
           └--> [链路追踪] ---> [SkyWalking / Jaeger]
```

---

## ✅ 总结

1. **压测工具 = 造流量**

   * 生成高并发请求，模拟真实用户行为
2. **监控体系 = 瓶颈定位**

   * 系统指标 + 应用指标 + 链路追踪 + 日志
3. **全链路压测 = 流量 + 监控 + 分析**

   * 缺一不可
4. **方案可扩展**

   * K6、JMeter、Locust 等工具可替换
   * 核心是统一场景配置 + 分布式发压 + 全链路监控

